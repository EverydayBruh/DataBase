# НИЯУ МИФИ. Лабораторная работа №3. Журбенко Василий, Б21-525. 2024

## SQL сценарии
1. [Инициализация](./scripts/1_init_db.sql)
2. [Заполнение](./scripts/2_insert_db.sql)
3. [Select-запросы](./scripts/3_select.sql)

## Запросы и результаты

### 1. Выборка клиентов со скидкой более 5%

#### Смысл запроса

Получить список клиентов, имеющих скидку более 5%, чтобы целенаправленно работать с ними для улучшения лояльности.

#### Ожидаемый результат

Список имён и фамилий клиентов, чья скидка превышает 5%.

#### SQL запрос

```sql
SELECT c.first_name, c.last_name
FROM customers c
WHERE c.discount > 5.0;
```
<details>
<summary>Результат</summary>

| first_name | last_name |
|------------|------------|
| Наталья    | Соловьева |
| Юлия       | Петрова   |
| Елена      | Иванова   |

</details>

### 2. Выборка информации о продажах, продавцах и покупателях

#### Смысл запроса

Получить полную информацию о продажах, включая имена продавцов и покупателей, дату продажи, количество и скидку, чтобы анализировать продажи и взаимодействие с клиентами.

#### Ожидаемый результат

Список с именами и фамилиями продавцов и покупателей, датой продажи, количеством проданных товаров и скидкой.

#### SQL запрос

```sql
SELECT s.first_name AS seller_name, s.last_name AS seller_last_name,
       c.first_name AS customer_name, c.last_name AS customer_last_name,
       sa.sale_date, sa.quantity, sa.discount
FROM sales sa
JOIN sellers s ON sa.seller_id = s.id
JOIN customers c ON sa.seller_id = c.id;
```
details>
<summary>Результат запроса</summary>

| seller_name | seller_last_name | customer_name | customer_last_name | sale_date | quantity | discount |
|-------------|------------------|----------------|---------------------|-----------|----------|----------|
| Иван        | Петров           | Елена         | Иванова             | 2023-05-01| 1        | 10.0     |
| Анна        | Смирнова         | Андрей        | Сидоров             | 2023-05-02| 2        | 0.0      |
| Михаил      | Кузнецов         | Татьяна       | Кузнецова           | 2023-05-03| 1        | 5.0      |
| Ольга       | Соколова         | Сергей        | Попов               | 2023-05-04| 1        | 0.0      |
| Екатерина   | Григорьева       | Наталья       | Соловьева           | 2023-05-05| 2        | 10.0     |
| Александр   | Морозов          | Игорь         | Козлов              | 2023-05-06| 1        | 8.0      |
| Марина      | Павлова          | Юлия          | Петрова             | 2023-05-07| 1        | 0.0      |
| Дмитрий     | Васильев         | Алексей       | Новиков             | 2023-05-08| 2        | 10.0     |
| Анна        | Смирнова         | Андрей        | Сидоров             | 2023-06-01| 1        | 0.0      |
| Михаил      | Кузнецов         | Татьяна       | Кузнецова           | 2023-06-02| 3        | 5.0      |
| Ольга       | Соколова         | Сергей        | Попов               | 2023-06-03| 1        | 10.0     |
| Екатерина   | Григорьева       | Наталья       | Соловьева           | 2023-06-04| 1        | 8.0      |
| Александр   | Морозов          | Игорь         | Козлов              | 2023-06-05| 1        | 0.0      |
| Марина      | Павлова          | Юлия          | Петрова             | 2023-06-06| 2        | 10.0     |
| Дмитрий     | Васильев         | Алексей       | Новиков             | 2023-06-07| 1        | 5.0      |
| Иван        | Петров           | Елена         | Иванова             | 2023-06-08| 1        | 0.0      |

</details>

### 3. Выборка информации о товарах и поставщиках

#### Смысл запроса

Получить информацию о товарах и соответствующих поставщиках, чтобы иметь представление о цепочке поставок.

#### Ожидаемый результат

Список товаров с указанием имени поставщика и контактной информации.

#### SQL запрос

```sql
SELECT p.name AS product_name, s.name AS supplier_name, s.contact_info
FROM products p
LEFT JOIN suppliers s ON p.supplier_id = s.id;
```

<details>
<summary>Результат</summary>

| product_name           | supplier_name        | contact_info                                           |
|------------------------|----------------------|--------------------------------------------------------|
| Золотое кольцо         | ООО "Золотая россыпь"| Телефон: +7 (495) 123-45-67, Email: gold@ros.ru       |
| Серебряная цепочка     | ИП "Серебряный ветер"| Телефон: +7 (495) 234-56-78, Email: silver@wind.ru    |
| Бриллиантовые серьги   | АО "Бриллиант Плюс"  | Телефон: +7 (495) 345-67-89, Email: brillant@plus.ru  |
| Изумрудное колье       | ООО "Драгоценные камни"| Телефон: +7 (495) 456-78-90, Email: gems@precious.ru|
| Рубиновый браслет      | ООО "Золотая россыпь"| Телефон: +7 (495) 123-45-67, Email: gold@ros.ru       |
| Жемчужные бусы         | ИП "Серебряный ветер"| Телефон: +7 (495) 234-56-78, Email: silver@wind.ru    |
| Сапфировое кольцо      | АО "Бриллиант Плюс"  | Телефон: +7 (495) 345-67-89, Email: brillant@plus.ru  |
| Изумрудные серьги      | ООО "Драгоценные камни"| Телефон: +7 (495) 456-78-90, Email: gems@precious.ru|

</details>

### 4. Ранжирование продавцов по количеству продаж

#### Смысл запроса

Ранжировать продавцов по количеству продаж, чтобы выявить наиболее успешных сотрудников.

#### Ожидаемый результат

Список имён и фамилий продавцов, количество продаж и их ранжирование по количеству продаж.

#### SQL запрос

```sql
SELECT s.first_name, s.last_name, COUNT(sa.id) AS sales_count,
       RANK() OVER (ORDER BY COUNT(sa.id) DESC) AS sales_rank
FROM sellers s
LEFT JOIN sales sa ON s.id = sa.seller_id
GROUP BY s.id
ORDER BY sales_rank;
```
<details>
<summary>Результат</summary>

| first_name | last_name | sales_count | sales_rank |
|------------|------------|--------------|------------|
| Иван       | Петров     | 2           | 1          |
| Анна       | Смирнова   | 2           | 1          |
| Михаил     | Кузнецов   | 2           | 1          |
| Ольга      | Соколова   | 2           | 1          |
| Екатерина  | Григорьева | 2           | 1          |
| Александр  | Морозов    | 2           | 1          |
| Марина     | Павлова    | 2           | 1          |
| Дмитрий    | Васильев   | 2           | 1          |

</details>

### 5. Подсчёт накопительного итога продаж по датам

#### Смысл запроса

Вести учёт накопительного итога продаж по датам, чтобы отслеживать динамику продаж.

#### Ожидаемый результат

Список дат продаж и накопительный итог количества проданных товаров на каждую дату.

#### SQL запрос

```sql
SELECT sale_date,
       SUM(quantity) OVER (ORDER BY sale_date) AS running_total
FROM sales;
```

<details>
<summary>Результат</summary>

| sale_date | running_total |
|-----------|----------------|
| 2023-05-01| 1             |
| 2023-05-02| 3             |
| 2023-05-03| 4             |
| 2023-05-04| 5             |
| 2023-05-05| 7             |
| 2023-05-06| 8             |
| 2023-05-07| 9             |
| 2023-05-08| 11            |
| 2023-06-01| 12            |
| 2023-06-02| 15            |
| 2023-06-03| 16            |
| 2023-06-04| 17            |
| 2023-06-05| 18            |
| 2023-06-06| 20            |
| 2023-06-07| 21            |
| 2023-06-08| 22            |

</details>

### 6. Получение списка продуктов с общим количеством на складе

#### Смысл запроса
Получить список всех продуктов с указанием общего количества единиц этого продукта, имеющегося на складах во всех отделах. Это позволит оценить запасы товаров и распределение между отделами.

#### Ожидаемый результат
Список продуктов с указанием названия продукта и общего количества единиц на складах.

#### SQL запрос
```sql
WITH product_totals AS (
  SELECT p.id, p.name, SUM(i.quantity) AS total_quantity
  FROM products p
  LEFT JOIN inventory i ON p.id = i.product_id
  GROUP BY p.id
)
SELECT name, total_quantity
FROM product_totals
ORDER BY total_quantity DESC;
```

<details>
<summary>Результат</summary>

| name                | total_quantity |
|----------------------|-----------------|
| Серебряная цепочка   | 30             |
| Жемчужные бусы       | 23             |
| Сапфировое кольцо    | 16             |
| Золотое кольцо       | 15             |
| Рубиновый браслет    | 14             |
| Изумрудные серьги    | 13             |
| Бриллиантовые серьги | 8              |
| Изумрудное колье     | 5              |

</details>

### 7. Вывод списка проданных товаров с количеством и суммарной выручкой за последний месяц

#### Смысл запроса

Получить данные о проданных товарах за последний месяц, чтобы анализировать продажи и выручку за этот период.

#### Ожидаемый результат

Список товаров с указанием количества проданных единиц и суммарной выручки за последний месяц.

#### SQL запрос

```sql
WITH sales_last_month AS (
  SELECT p.name, SUM(s.quantity) AS total_quantity, SUM(s.quantity * p.sale_price * (1 - COALESCE(s.discount, 0))) AS total_revenue
  FROM sales s
  JOIN products p ON s.product_id = p.id
  WHERE s.sale_date >= DATE('now', '-1 month')
  GROUP BY p.name
)
SELECT name, total_quantity, total_revenue
FROM sales_last_month
ORDER BY total_revenue DESC;
```

<details>
<summary>Результат</summary>

| name                | total_quantity | total_revenue |
|----------------------|-----------------|----------------|
| Изумрудное колье     | 3               | 285000.0      |
| Бриллиантовые серьги | 2               | 76000.0       |
| Рубиновый браслет    | 1               | 30000.0       |
| Жемчужные бусы       | 1               | 15000.0       |

</details>

### 8. Получение товаров с самой большой наценкой в разрезе поставщиков

#### Смысл запроса

Определить товары с наибольшей наценкой у каждого поставщика, чтобы выявить наиболее прибыльные позиции.

#### Ожидаемый результат

Список товаров с наибольшей наценкой и соответствующих поставщиков.

#### SQL запрос

```sql
WITH product_markup AS (
  SELECT p.id, p.name, p.supplier_id, (p.sale_price - p.purchase_price) AS markup,
    RANK() OVER (PARTITION BY p.supplier_id ORDER BY (p.sale_price - p.purchase_price) DESC) AS rnk
  FROM products p
)
SELECT p.name AS product, s.name AS supplier, p.markup
FROM product_markup p
JOIN suppliers s ON p.supplier_id = s.id
WHERE p.rnk = 1
ORDER BY p.markup DESC;
```
<details>
<summary>Результат</summary>

| product            | supplier              | markup  |
|---------------------|------------------------|---------|
| Изумрудное колье   | ООО "Драгоценные камни"| 100000.0|
| Бриллиантовые серьги| АО "Бриллиант Плюс"   | 40000.0 |
| Рубиновый браслет  | ООО "Золотая россыпь"  | 30000.0 |
| Жемчужные бусы     | ИП "Серебряный ветер"  | 15000.0 |

</details>

## Заключение

В ходе выполнения данной лабораторной работы были изучены и применены на практике различные возможности SQL для формирования сложных запросов на выборку данных. Были рассмотрены подзапросы, соединения таблиц с использованием различных видов операций JOIN, теоретико-множественные операции объединения, пересечения и вычитания результатов запросов, а также обычные и рекурсивные табличные выражения. 
Всего были разработаны 8 SQL-запросов для извлечения и анализа разнообразной информации, необходимой для принятия управленческих решений.